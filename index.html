<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }
        
        .file-input {
            margin: 15px 0;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-print {
            background-color: #27ae60;
        }
        
        .btn-print:hover {
            background-color: #219653;
        }
        
        .btn-pdf {
            background-color: #e74c3c;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .editable {
            background-color: #fffde7;
            cursor: pointer;
            width: 100%;
            border: none;
            padding: 5px;
        }
        
        .editable:focus {
            background-color: #fff9c4;
            outline: 2px solid #3498db;
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .printable-area {
            display: none;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #333;
            padding-bottom: 20px;
        }
        
        .print-header h2 {
            font-size: 28px;
            margin: 0;
            color: #2c3e50;
        }
        
        .print-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .print-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
        }
        
        .print-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .print-summary {
            margin-top: 30px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 6px;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        
        .address-section {
            margin: 20px 0;
        }
        
        .print-address {
            margin: 15px 0;
            padding: 10px;
            border: 1px dashed #ccc;
        }
        
        .contact-section {
            margin: 20px 0;
        }
        
        .contact-details {
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .contact-details p {
            margin: 5px 0;
        }
        
        .bold-yellow {
            font-weight: bold;
            background-color: yellow;
            padding: 5px 10px;
            display: inline-block;
        }
        
        .contact-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .store-person-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .date-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section no-print">
            <h3>Upload Excel File</h3>
            <p>Your Excel should contain columns: Sl No, Vendor Name, Code, Products Name, CPU, PO Qty</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
            <button id="uploadBtn" class="btn">Upload and Process</button>
        </div>
        
        <div id="poForm" class="no-print" style="display: none;">
            <h3>Purchase Order Details</h3>
            
            <div class="filter-section">
                <div class="form-group">
                    <label for="vendorFilter">Filter by Vendor:</label>
                    <select id="vendorFilter">
                        <option value="all">All Vendors</option>
                    </select>
                </div>
                
                <div class="date-section">
                    <div class="form-group">
                        <label for="poDate">PO Date:</label>
                        <input type="date" id="poDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryDate">Delivery Date:</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="refNo">Reference No:</label>
                    <input type="text" id="refNo">
                </div>
                
                <div class="form-group">
                    <label for="storeName">Store Name:</label>
                    <input type="text" id="storeName">
                </div>
            </div>
            
            <div class="address-section">
                <div class="form-group">
                    <label for="deliveryAddress">Delivery Address:</label>
                    <textarea id="deliveryAddress" rows="3"></textarea>
                </div>
            </div>
            
            <div class="store-person-section">
                <div class="form-group">
                    <label for="storePersonName">Store Person's Name:</label>
                    <input type="text" id="storePersonName" placeholder="Enter store person's name">
                </div>
                
                <div class="form-group">
                    <label for="storePersonPhone">Store Person's Phone:</label>
                    <input type="text" id="storePersonPhone" placeholder="Enter store person's phone">
                </div>
            </div>
            
            <div class="contact-section">
                <h4>Contact Person Details</h4>
                <div class="contact-form">
                    <div class="form-group">
                        <label for="contactName">Contact Person Name:</label>
                        <input type="text" id="contactName" value="Md Hadisur Rahman">
                    </div>
                    
                    <div class="form-group">
                        <label for="contactPhone">Contact Phone:</label>
                        <input type="text" id="contactPhone" value="+8801329732463">
                    </div>
                    
                    <div class="form-group">
                        <label for="contactEmail">Contact Email:</label>
                        <input type="email" id="contactEmail" value="hadisur.rahman@roshodfps.com">
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="poTable">
                    <thead>
                        <tr>
                            <th>Sl No</th>
                            <th>Vendor Name</th>
                            <th>Code</th>
                            <th>Products Name</th>
                            <th>CPU</th>
                            <th>PO Qty</th>
                            <th>PO Value</th>
                        </tr>
                    </thead>
                    <tbody id="poTableBody">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                Total PO Value: <span id="totalValue">0.00</span>
            </div>
            
            <div class="button-group">
                <button id="printBtn" class="btn btn-print">Print PO</button>
                <button id="pdfBtn" class="btn btn-pdf">Generate PDF</button>
            </div>
        </div>
        
        <div id="printableArea" class="printable-area">
            <div class="print-header">
                <h2>ROSHOD</h2>
                <h3>PURCHASE ORDER</h3>
            </div>
            
            <div class="print-details">
                <div>
                    <p><strong>PO Date:</strong> <span id="printDate"></span></p>
                    <p><strong>Reference No:</strong> <span id="printRefNo"></span></p>
                    <p><strong>Delivery Date:</strong> <span id="printDeliveryDate"></span></p>
                    <p><strong>Store Person:</strong> <span id="printStorePersonName"></span></p>
                    <p><strong>Store Person Phone:</strong> <span id="printStorePersonPhone"></span></p>
                </div>
                <div>
                    <p><strong>Store Name:</strong> <span id="printStoreName"></span></p>
                    <p><strong>Vendor:</strong> <span id="printVendor"></span></p>
                </div>
            </div>
            
            <div class="print-address">
                <p><strong>Delivery Address:</strong></p>
                <p id="printDeliveryAddress"></p>
            </div>
            
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>Code</th>
                        <th>Products Name</th>
                        <th>CPU</th>
                        <th>PO Qty</th>
                        <th>PO Value</th>
                    </tr>
                </thead>
                <tbody id="printTableBody">
                    <!-- Printable table rows will be inserted here -->
                </tbody>
            </table>
            
            <div class="print-summary">
                <p>Total PO Value: <span id="printTotalValue" class="bold-yellow">0.00</span></p>
            </div>
            
            <div class="contact-details">
                <p><strong>For questions concerning this invoice, please contact:</strong></p>
                <p>Name: <span id="printContactName">Md Hadisur Rahman</span></p>
                <p>Phone: <span id="printContactPhone">+8801329732463</span></p>
                <p>Email Address: <span id="printContactEmail">hadisur.rahman@roshodfps.com</span></p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const poForm = document.getElementById('poForm');
            const poTableBody = document.getElementById('poTableBody');
            const vendorFilter = document.getElementById('vendorFilter');
            const totalValueSpan = document.getElementById('totalValue');
            const printBtn = document.getElementById('printBtn');
            const pdfBtn = document.getElementById('pdfBtn');
            const printableArea = document.getElementById('printableArea');
            const printTableBody = document.getElementById('printTableBody');
            const printTotalValue = document.getElementById('printTotalValue');
            const printDate = document.getElementById('printDate');
            const printRefNo = document.getElementById('printRefNo');
            const printStoreName = document.getElementById('printStoreName');
            const printVendor = document.getElementById('printVendor');
            const printDeliveryAddress = document.getElementById('printDeliveryAddress');
            const printContactName = document.getElementById('printContactName');
            const printContactPhone = document.getElementById('printContactPhone');
            const printContactEmail = document.getElementById('printContactEmail');
            const printStorePersonName = document.getElementById('printStorePersonName');
            const printStorePersonPhone = document.getElementById('printStorePersonPhone');
            const printDeliveryDate = document.getElementById('printDeliveryDate');
            
            let poData = [];
            let vendors = [];
            
            // Set today's date as default for both PO Date and Delivery Date
            const today = new Date();
            document.getElementById('poDate').valueAsDate = today;
            
            // Set delivery date to 7 days from today by default
            const deliveryDate = new Date();
            deliveryDate.setDate(today.getDate() + 7);
            document.getElementById('deliveryDate').valueAsDate = deliveryDate;
            
            uploadBtn.addEventListener('click', function() {
                if (!fileInput.files.length) {
                    alert('Please select an Excel file to upload.');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Assuming the first sheet is the one we need
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processExcelData(jsonData);
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            function processExcelData(data) {
                poData = data.map((row, index) => {
                    return {
                        originalSlNo: row['Sl No'] || index + 1,
                        vendorName: row['Vendor Name'] || '',
                        code: row['Code'] || '',
                        productName: row['Products Name'] || '',
                        cpu: parseFloat(row['CPU']) || 0,
                        poQty: parseInt(row['PO Qty']) || 0,
                        poValue: (parseFloat(row['CPU']) || 0) * (parseInt(row['PO Qty']) || 0)
                    };
                });
                
                // Extract unique vendors
                vendors = [...new Set(poData.map(item => item.vendorName))].filter(v => v);
                
                // Populate vendor filter
                vendorFilter.innerHTML = '<option value="all">All Vendors</option>';
                vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    option.textContent = vendor;
                    vendorFilter.appendChild(option);
                });
                
                // Display the data
                renderTable();
                poForm.style.display = 'block';
                
                // Calculate initial total
                calculateTotalValue();
            }
            
            function renderTable() {
                poTableBody.innerHTML = '';
                const selectedVendor = vendorFilter.value;
                
                const filteredData = selectedVendor === 'all' 
                    ? poData 
                    : poData.filter(item => item.vendorName === selectedVendor);
                
                // Auto-generate SL numbers for filtered data
                filteredData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const slNo = index + 1; // Auto-generated SL number
                    
                    row.innerHTML = `
                        <td>${slNo}</td>
                        <td>${item.vendorName}</td>
                        <td>${item.code}</td>
                        <td>${item.productName}</td>
                        <td><input type="number" class="editable cpu" value="${item.cpu}" data-index="${poData.indexOf(item)}" step="0.01"></td>
                        <td><input type="number" class="editable poQty" value="${item.poQty}" data-index="${poData.indexOf(item)}"></td>
                        <td class="poValue">${item.poValue.toFixed(2)}</td>
                    `;
                    
                    poTableBody.appendChild(row);
                });
                
                // Add event listeners to editable fields
                document.querySelectorAll('.editable').forEach(input => {
                    input.addEventListener('change', handleCellEdit);
                });
            }
            
            function handleCellEdit(e) {
                const index = parseInt(e.target.dataset.index);
                const field = e.target.classList.contains('cpu') ? 'cpu' : 'poQty';
                const value = parseFloat(e.target.value) || 0;
                
                // Update the data
                poData[index][field] = value;
                
                // Recalculate PO Value
                poData[index].poValue = poData[index].cpu * poData[index].poQty;
                
                // Update the displayed PO Value
                const row = e.target.closest('tr');
                row.querySelector('.poValue').textContent = poData[index].poValue.toFixed(2);
                
                // Recalculate total
                calculateTotalValue();
            }
            
            function calculateTotalValue() {
                const selectedVendor = vendorFilter.value;
                const filteredData = selectedVendor === 'all' 
                    ? poData 
                    : poData.filter(item => item.vendorName === selectedVendor);
                
                const total = filteredData.reduce((sum, item) => sum + item.poValue, 0);
                totalValueSpan.textContent = total.toFixed(2);
            }
            
            vendorFilter.addEventListener('change', function() {
                renderTable();
                calculateTotalValue();
            });
            
            printBtn.addEventListener('click', function() {
                generatePrintablePO();
                printableArea.style.display = 'block';
                window.print();
                printableArea.style.display = 'none';
            });
            
            pdfBtn.addEventListener('click', function() {
                generatePrintablePO();
                printableArea.style.display = 'block';
                
                // Use html2canvas and jsPDF to generate PDF
                html2canvas(printableArea, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    // Add new page if content is too long
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save('purchase_order.pdf');
                    printableArea.style.display = 'none';
                });
            });
            
            function generatePrintablePO() {
                // Get header values
                const poDate = document.getElementById('poDate').value;
                const refNo = document.getElementById('refNo').value;
                const storeName = document.getElementById('storeName').value;
                const deliveryAddress = document.getElementById('deliveryAddress').value;
                const selectedVendor = vendorFilter.value;
                const contactName = document.getElementById('contactName').value;
                const contactPhone = document.getElementById('contactPhone').value;
                const contactEmail = document.getElementById('contactEmail').value;
                const storePersonName = document.getElementById('storePersonName').value;
                const storePersonPhone = document.getElementById('storePersonPhone').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                
                // Set print header values
                printDate.textContent = poDate;
                printRefNo.textContent = refNo;
                printStoreName.textContent = storeName;
                printVendor.textContent = selectedVendor === 'all' ? 'Multiple Vendors' : selectedVendor;
                printDeliveryAddress.textContent = deliveryAddress || 'Not specified';
                printContactName.textContent = contactName;
                printContactPhone.textContent = contactPhone;
                printContactEmail.textContent = contactEmail;
                printStorePersonName.textContent = storePersonName || 'Not specified';
                printStorePersonPhone.textContent = storePersonPhone || 'Not specified';
                printDeliveryDate.textContent = deliveryDate || 'Not specified';
                
                // Generate printable table
                printTableBody.innerHTML = '';
                
                const filteredData = selectedVendor === 'all' 
                    ? poData 
                    : poData.filter(item => item.vendorName === selectedVendor);
                
                let totalValue = 0;
                
                // Auto-generate SL numbers for filtered data in PDF
                filteredData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const slNo = index + 1; // Auto-generated SL number
                    
                    row.innerHTML = `
                        <td>${slNo}</td>
                        <td>${item.code}</td>
                        <td>${item.productName}</td>
                        <td>${item.cpu.toFixed(2)}</td>
                        <td>${item.poQty}</td>
                        <td>${item.poValue.toFixed(2)}</td>
                    `;
                    
                    printTableBody.appendChild(row);
                    
                    totalValue += item.poValue;
                });
                
                printTotalValue.textContent = totalValue.toFixed(2);
            }
        });
    </script>
</body>
</html>