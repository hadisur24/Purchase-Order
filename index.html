<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
            text-align: center;
            position: relative;
        }
        
        .file-input {
            margin: 15px 0;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-print {
            background-color: #27ae60;
        }
        
        .btn-print:hover {
            background-color: #219653;
        }
        
        .btn-pdf {
            background-color: #e74c3c;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        .btn-clear {
            background-color: #f39c12;
        }
        
        .btn-clear:hover {
            background-color: #e67e22;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .editable {
            background-color: #fffde7;
            cursor: pointer;
            width: 100%;
            border: none;
            padding: 5px;
        }
        
        .editable:focus {
            background-color: #fff9c4;
            outline: 2px solid #3498db;
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .total-box {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 18px;
        }
        
        .printable-area {
            display: none;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #333;
            padding-bottom: 20px;
        }
        
        .print-header h2 {
            font-size: 28px;
            margin: 0;
            color: #2c3e50;
        }
        
        .print-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .print-details-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .print-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .print-details-label {
            font-weight: 600;
            min-width: 140px;
        }
        
        .print-details-value {
            flex: 1;
            text-align: left;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .print-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
        }
        
        .print-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .print-summary {
            margin-top: 30px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 6px;
            text-align: right;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        
        .address-section {
            margin: 20px 0;
        }
        
        .print-address {
            margin: 15px 0;
            padding: 10px;
            border: 1px dashed #ccc;
        }
        
        .contact-section {
            margin: 20px 0;
        }
        
        .contact-details {
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .contact-details p {
            margin: 5px 0;
        }
        
        .bold-yellow {
            font-weight: bold;
            background-color: yellow;
            padding: 5px 10px;
            display: inline-block;
        }
        
        .contact-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .store-person-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .date-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .logo-section, .signature-section {
            margin: 15px 0;
            text-align: center;
        }
        
        .logo-preview, .signature-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px auto;
            display: block;
        }
        
        .logo-placeholder, .signature-placeholder {
            width: 200px;
            height: 100px;
            background-color: #f0f0f0;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #ccc;
            color: #666;
        }
        
        .store-select {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 10px;
            border-top: 1px solid #ddd;
            font-size: 14px;
            color: #666;
        }
        
        .footer a {
            color: #3498db;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .security-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .security-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 400px;
            max-width: 90%;
        }
        
        .security-modal h3 {
            margin-top: 0;
            color: #e74c3c;
        }
        
        .security-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .clear-data-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
        }
        
        .print-signature {
            margin: 20px 0;
            text-align: left;
        }
        
        .print-contact-two-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            text-align: center;
        }
        
        .print-contact-line1 {
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .print-contact-line2 {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section no-print">
            <h3>Upload Excel File</h3>
            <p>Your Excel should contain columns: Sl No, Vendor Name, Code, Products Name, CPU, PO Qty, Store Name</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
            <button id="uploadBtn" class="btn">Upload and Process</button>
            
            
        </div>
        
        <div id="poForm" class="no-print" style="display: none;">
            <h3>Purchase Order Details</h3>
            
            <div class="logo-section">
                <h4>Company Logo (for PDF)</h4>
                <input type="file" id="logoInput" class="file-input" accept="image/*">
                <div id="logoPreview" class="logo-placeholder">Logo Preview</div>
                <button id="removeLogoBtn" class="btn" style="display: none;">Remove Logo</button>
            </div>
            
            <div class="signature-section">
                <h4>Signature (for PDF)</h4>
                <input type="file" id="signatureInput" class="file-input" accept="image/*">
                <div id="signaturePreview" class="signature-placeholder">Signature Preview</div>
                <button id="removeSignatureBtn" class="btn" style="display: none;">Remove Signature</button>
            </div>
            
            <div class="filter-section">
                <div class="form-group">
                    <label for="vendorFilter">Filter by Vendor:</label>
                    <select id="vendorFilter">
                        <option value="all">All Vendors</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="storeFilter">Filter by Store:</label>
                    <select id="storeFilter">
                        <option value="all">All Stores</option>
                    </select>
                </div>
                
                <div class="date-section">
                    <div class="form-group">
                        <label for="poDate">PO Date:</label>
                        <input type="date" id="poDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryDate">Delivery Date:</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="refNo">Reference No:</label>
                    <input type="text" id="refNo">
                </div>
                
                <div class="form-group">
                    <label for="storeName">Main Store Name:</label>
                    <select id="storeName" class="store-select">
                        <option value="">Select Store</option>
                        <option value="NORP KNIT">NORP KNIT</option>
                        <option value="ESL">ESL</option>
                        <option value="ICCL">ICCL</option>
                        <option value="HA-MEEM">HA-MEEM</option>
                        <option value="RUPSHI">RUPSHI</option>
                        <option value="GBAL">GBAL</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="address-section">
                <div class="form-group">
                    <label for="deliveryAddress">Delivery Address:</label>
                    <textarea id="deliveryAddress" rows="3"></textarea>
                </div>
            </div>
            
            <div class="store-person-section">
                <div class="form-group">
                    <label for="storePersonName">Store Person's Name:</label>
                    <input type="text" id="storePersonName" placeholder="Enter store person's name">
                </div>
                
                <div class="form-group">
                    <label for="storePersonPhone">Store Person's Phone:</label>
                    <input type="text" id="storePersonPhone" placeholder="Enter store person's phone">
                </div>
            </div>
            
            <div class="contact-section">
                <h4>Contact Person Details</h4>
                <div class="contact-form">
                    <div class="form-group">
                        <label for="contactName">Contact Person Name:</label>
                        <input type="text" id="contactName" value="Md Hadisur Rahman">
                    </div>
                    
                    <div class="form-group">
                        <label for="contactPhone">Contact Phone:</label>
                        <input type="text" id="contactPhone" value="+8801329732463">
                    </div>
                    
                    <div class="form-group">
                        <label for="contactEmail">Contact Email:</label>
                        <input type="email" id="contactEmail" value="hadisur.rahman@roshodfps.com">
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="poTable">
                    <thead>
                        <tr>
                            <th>Sl No</th>
                            <th>Vendor Name</th>
                            <th>Code</th>
                            <th>Products Name</th>
                            <th>Store Name</th>
                            <th>CPU</th>
                            <th>PO Qty</th>
                            <th>PO Value</th>
                        </tr>
                    </thead>
                    <tbody id="poTableBody">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                <span>Total PO Value:</span>
                <span class="total-box" id="totalValue">0.00</span>
            </div>
            
            <div class="button-group">
                <button id="printBtn" class="btn btn-print">Print PO</button>
                <button id="pdfBtn" class="btn btn-pdf">Generate PDF</button>
                <button id="clearBtn" class="btn btn-clear">Clear Data</button>
            </div>
            
            <div class="clear-data-section">
                <h4>Clear All Data</h4>
                <p>This will remove all uploaded data and reset the form. This action cannot be undone.</p>
                <button id="clearDataBtn" class="btn btn-clear">Clear All Data</button>
            </div>
        </div>
<div class="footer">
                <p>Operated by <a href="https://www.linkedin.com/in/md-hadisur-rahman24" target="_blank">Hadisur Rahman</a></p>
            </div>
        
        <div id="printableArea" class="printable-area">
            <div class="print-header">
                <div id="printLogoContainer">
                    <!-- Logo will be inserted here -->
                </div>
                <h3>PURCHASE ORDER</h3>
            </div>
            
            <div class="print-details">
                <div class="print-details-column">
                    <div class="print-details-row">
                        <span class="print-details-label">PO Date:</span>
                        <span class="print-details-value" id="printDate"></span>
                    </div>
                    <div class="print-details-row">
                        <span class="print-details-label">Reference No:</span>
                        <span class="print-details-value" id="printRefNo"></span>
                    </div>
                    <div class="print-details-row">
                        <span class="print-details-label">Delivery Date:</span>
                        <span class="print-details-value" id="printDeliveryDate"></span>
                    </div>
                </div>
                <div class="print-details-column">
                    <div class="print-details-row">
                        <span class="print-details-label">Store Person:</span>
                        <span class="print-details-value" id="printStorePersonName"></span>
                    </div>
                    <div class="print-details-row">
                        <span class="print-details-label">Store Person Phone:</span>
                        <span class="print-details-value" id="printStorePersonPhone"></span>
                    </div>
                    <div class="print-details-row">
                        <span class="print-details-label">Main Store Name:</span>
                        <span class="print-details-value" id="printStoreName"></span>
                    </div>
                    <div class="print-details-row">
                        <span class="print-details-label">Vendor:</span>
                        <span class="print-details-value" id="printVendor"></span>
                    </div>
                </div>
            </div>
            
            <div class="print-address">
                <p><strong>Delivery Address:</strong></p>
                <p id="printDeliveryAddress"></p>
            </div>
            
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>Code</th>
                        <th>Products Name</th>
                        <th>CPU</th>
                        <th>PO Qty</th>
                        <th>PO Value</th>
                    </tr>
                </thead>
                <tbody id="printTableBody">
                    <!-- Printable table rows will be inserted here -->
                </tbody>
            </table>
            
            <div class="print-summary">
                <p>Total PO Value: <span id="printTotalValue" class="bold-yellow">0.00</span></p>
            </div>
            
            <div class="print-signature">
                <div id="printSignatureContainer">
                    <!-- Signature will be inserted here -->
                </div>
                <p>Authorized Signature</p>
            </div>
            
            <div class="print-contact-two-line">
                <p class="print-contact-line1">For questions concerning this invoice, please contact</p>
                <p class="print-contact-line2">Name: <span id="printContactName">Md Hadisur Rahman</span>, Phone: <span id="printContactPhone">+8801329732463</span>, Email Address: <span id="printContactEmail">hadisur.rahman@roshodfps.com</span></p>
            </div>
        </div>
    </div>

    <!-- Security Modal -->
    <div id="securityModal" class="security-modal">
        <div class="security-modal-content">
            <h3>Clear Data Confirmation</h3>
            <p>Please enter the security code to clear all data:</p>
            <div class="form-group">
                <input type="password" id="securityCode" placeholder="Enter security code">
            </div>
            <div class="security-modal-buttons">
                <button id="cancelClearBtn" class="btn">Cancel</button>
                <button id="confirmClearBtn" class="btn btn-clear">Clear Data</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const poForm = document.getElementById('poForm');
            const poTableBody = document.getElementById('poTableBody');
            const vendorFilter = document.getElementById('vendorFilter');
            const storeFilter = document.getElementById('storeFilter');
            const totalValueSpan = document.getElementById('totalValue');
            const printBtn = document.getElementById('printBtn');
            const pdfBtn = document.getElementById('pdfBtn');
            const clearBtn = document.getElementById('clearBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const printableArea = document.getElementById('printableArea');
            const printTableBody = document.getElementById('printTableBody');
            const printTotalValue = document.getElementById('printTotalValue');
            const printDate = document.getElementById('printDate');
            const printRefNo = document.getElementById('printRefNo');
            const printStoreName = document.getElementById('printStoreName');
            const printVendor = document.getElementById('printVendor');
            const printDeliveryAddress = document.getElementById('printDeliveryAddress');
            const printContactName = document.getElementById('printContactName');
            const printContactPhone = document.getElementById('printContactPhone');
            const printContactEmail = document.getElementById('printContactEmail');
            const printStorePersonName = document.getElementById('printStorePersonName');
            const printStorePersonPhone = document.getElementById('printStorePersonPhone');
            const printDeliveryDate = document.getElementById('printDeliveryDate');
            const logoInput = document.getElementById('logoInput');
            const logoPreview = document.getElementById('logoPreview');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const printLogoContainer = document.getElementById('printLogoContainer');
            const signatureInput = document.getElementById('signatureInput');
            const signaturePreview = document.getElementById('signaturePreview');
            const removeSignatureBtn = document.getElementById('removeSignatureBtn');
            const printSignatureContainer = document.getElementById('printSignatureContainer');
            const storeNameSelect = document.getElementById('storeName');
            const deliveryAddressTextarea = document.getElementById('deliveryAddress');
            const storePersonNameInput = document.getElementById('storePersonName');
            const storePersonPhoneInput = document.getElementById('storePersonPhone');
            const securityModal = document.getElementById('securityModal');
            const securityCodeInput = document.getElementById('securityCode');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            
            let poData = [];
            let vendors = [];
            let stores = [];
            let logoDataUrl = null;
            let signatureDataUrl = null;
            
            // Store details mapping
            const storeDetails = {
                "NORP KNIT": {
                    address: "Norp Knit Industries Ltd. Unit 02, Shi-152/2, Islampur, Kodda, Nandun, Bason, Gazipur -1700, Bangladesh",
                    personName: "Sajan",
                    personPhone: "+8801816017317"
                },
                "ESL": {
                    address: "SHOP-2 Everbright Sweaters Ltd., Kathgora - Mridhabari Rd, Zirabo 1341",
                    personName: "Ratna",
                    personPhone: "+8801609989238"
                },
                "ICCL": {
                    address: "SHOP-3 International Classic Composite Ltd. Naojur, Kodda, Joydebpur, Gazipur",
                    personName: "Pritom",
                    personPhone: "+8801614149002"
                },
                "HA-MEEM": {
                    address: "SHOP-4 Ha-Meem (Creative Collections Ltd.)69 & 107, Mil Gate, Iztema Gate, Nishat Nagar, Tongi",
                    personName: "Sourav",
                    personPhone: "+8801620220106"
                },
                "RUPSHI": {
                    address: "SHOP -5 Rupshi Complex, City Economic Zone, Rupshi ,Rupganj, Narayanganj",
                    personName: "Riazul Islam",
                    personPhone: "+8801621083113"
                },
                "GBAL": {
                    address: "SHOP -6 Good Bags & Accessories Ltd., Jadurchar Rd, Hemayetpur, Savar, Dhaka",
                    personName: "Sajib",
                    personPhone: "+8801797258811"
                }
            };
            
            // Load data from localStorage if available
            loadFromLocalStorage();
            
            // Set today's date as default for both PO Date and Delivery Date
            const today = new Date();
            document.getElementById('poDate').valueAsDate = today;
            
            // Set delivery date to 7 days from today by default
            const deliveryDate = new Date();
            deliveryDate.setDate(today.getDate() + 7);
            document.getElementById('deliveryDate').valueAsDate = deliveryDate;
            
            // Store name change handler
            storeNameSelect.addEventListener('change', function() {
                const selectedStore = this.value;
                
                if (selectedStore && selectedStore !== "Other" && storeDetails[selectedStore]) {
                    // Auto-fill the details
                    deliveryAddressTextarea.value = storeDetails[selectedStore].address;
                    storePersonNameInput.value = storeDetails[selectedStore].personName;
                    storePersonPhoneInput.value = storeDetails[selectedStore].personPhone;
                } else if (selectedStore === "Other") {
                    // Clear the fields for custom entry
                    deliveryAddressTextarea.value = "";
                    storePersonNameInput.value = "";
                    storePersonPhoneInput.value = "";
                }
                // If the store is not in the list, do nothing (keep existing values)
                
                // Save to localStorage
                saveToLocalStorage();
            });
            
            // Logo handling
            logoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoDataUrl = e.target.result;
                        logoPreview.innerHTML = `<img src="${logoDataUrl}" class="logo-preview" alt="Logo">`;
                        removeLogoBtn.style.display = 'inline-block';
                        saveToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeLogoBtn.addEventListener('click', function() {
                logoDataUrl = null;
                logoInput.value = '';
                logoPreview.innerHTML = 'Logo Preview';
                logoPreview.className = 'logo-placeholder';
                removeLogoBtn.style.display = 'none';
                saveToLocalStorage();
            });
            
            // Signature handling
            signatureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        signatureDataUrl = e.target.result;
                        signaturePreview.innerHTML = `<img src="${signatureDataUrl}" class="signature-preview" alt="Signature">`;
                        removeSignatureBtn.style.display = 'inline-block';
                        saveToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeSignatureBtn.addEventListener('click', function() {
                signatureDataUrl = null;
                signatureInput.value = '';
                signaturePreview.innerHTML = 'Signature Preview';
                signaturePreview.className = 'signature-placeholder';
                removeSignatureBtn.style.display = 'none';
                saveToLocalStorage();
            });
            
            // Security modal handlers
            clearDataBtn.addEventListener('click', function() {
                securityModal.style.display = 'flex';
                securityCodeInput.value = '';
            });
            
            cancelClearBtn.addEventListener('click', function() {
                securityModal.style.display = 'none';
            });
            
            confirmClearBtn.addEventListener('click', function() {
                if (securityCodeInput.value === '19591') {
                    clearAllData();
                    securityModal.style.display = 'none';
                    alert('All data has been cleared successfully.');
                } else {
                    alert('Invalid security code. Please try again.');
                }
            });
            
            // Close modal when clicking outside
            securityModal.addEventListener('click', function(e) {
                if (e.target === securityModal) {
                    securityModal.style.display = 'none';
                }
            });
            
            uploadBtn.addEventListener('click', function() {
                if (!fileInput.files.length) {
                    alert('Please select an Excel file to upload.');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Assuming the first sheet is the one we need
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processExcelData(jsonData);
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            function processExcelData(data) {
                poData = data.map((row, index) => {
                    return {
                        originalSlNo: row['Sl No'] || index + 1,
                        vendorName: row['Vendor Name'] || '',
                        code: row['Code'] || '',
                        productName: row['Products Name'] || '',
                        storeName: row['Store Name'] || '',
                        cpu: parseFloat(row['CPU']) || 0,
                        poQty: parseInt(row['PO Qty']) || 0,
                        poValue: (parseFloat(row['CPU']) || 0) * (parseInt(row['PO Qty']) || 0)
                    };
                });
                
                // Extract unique vendors
                vendors = [...new Set(poData.map(item => item.vendorName))].filter(v => v);
                
                // Extract unique stores
                stores = [...new Set(poData.map(item => item.storeName))].filter(s => s);
                
                // Populate vendor filter
                vendorFilter.innerHTML = '<option value="all">All Vendors</option>';
                vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    option.textContent = vendor;
                    vendorFilter.appendChild(option);
                });
                
                // Populate store filter
                storeFilter.innerHTML = '<option value="all">All Stores</option>';
                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    storeFilter.appendChild(option);
                });
                
                // Display the data
                renderTable();
                poForm.style.display = 'block';
                
                // Calculate initial total
                calculateTotalValue();
                
                // Save to localStorage
                saveToLocalStorage();
            }
            
            function renderTable() {
                poTableBody.innerHTML = '';
                const selectedVendor = vendorFilter.value;
                const selectedStore = storeFilter.value;
                
                const filteredData = poData.filter(item => {
                    const vendorMatch = selectedVendor === 'all' || item.vendorName === selectedVendor;
                    const storeMatch = selectedStore === 'all' || item.storeName === selectedStore;
                    return vendorMatch && storeMatch;
                });
                
                // Auto-generate SL numbers for filtered data
                filteredData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const slNo = index + 1; // Auto-generated SL number
                    
                    row.innerHTML = `
                        <td>${slNo}</td>
                        <td>${item.vendorName}</td>
                        <td>${item.code}</td>
                        <td>${item.productName}</td>
                        <td>${item.storeName}</td>
                        <td><input type="number" class="editable cpu" value="${item.cpu}" data-index="${poData.indexOf(item)}" step="0.01"></td>
                        <td><input type="number" class="editable poQty" value="${item.poQty}" data-index="${poData.indexOf(item)}"></td>
                        <td class="poValue">${item.poValue.toFixed(2)}</td>
                    `;
                    
                    poTableBody.appendChild(row);
                });
                
                // Add event listeners to editable fields
                document.querySelectorAll('.editable').forEach(input => {
                    input.addEventListener('change', handleCellEdit);
                });
            }
            
            function handleCellEdit(e) {
                const index = parseInt(e.target.dataset.index);
                const field = e.target.classList.contains('cpu') ? 'cpu' : 'poQty';
                const value = parseFloat(e.target.value) || 0;
                
                // Update the data
                poData[index][field] = value;
                
                // Recalculate PO Value
                poData[index].poValue = poData[index].cpu * poData[index].poQty;
                
                // Update the displayed PO Value
                const row = e.target.closest('tr');
                row.querySelector('.poValue').textContent = poData[index].poValue.toFixed(2);
                
                // Recalculate total
                calculateTotalValue();
                
                // Save to localStorage
                saveToLocalStorage();
            }
            
            function calculateTotalValue() {
                const selectedVendor = vendorFilter.value;
                const selectedStore = storeFilter.value;
                
                const filteredData = poData.filter(item => {
                    const vendorMatch = selectedVendor === 'all' || item.vendorName === selectedVendor;
                    const storeMatch = selectedStore === 'all' || item.storeName === selectedStore;
                    return vendorMatch && storeMatch;
                });
                
                const total = filteredData.reduce((sum, item) => sum + item.poValue, 0);
                totalValueSpan.textContent = total.toFixed(2);
            }
            
            vendorFilter.addEventListener('change', function() {
                renderTable();
                calculateTotalValue();
            });
            
            storeFilter.addEventListener('change', function() {
                renderTable();
                calculateTotalValue();
            });
            
            printBtn.addEventListener('click', function() {
                generatePrintablePO();
                printableArea.style.display = 'block';
                window.print();
                printableArea.style.display = 'none';
            });
            
            pdfBtn.addEventListener('click', function() {
                generatePDF();
            });
            
            function generatePDF() {
                // Get header values
                const poDate = document.getElementById('poDate').value;
                const refNo = document.getElementById('refNo').value;
                const mainStoreName = document.getElementById('storeName').value;
                const deliveryAddress = document.getElementById('deliveryAddress').value;
                const selectedVendor = vendorFilter.value;
                const selectedStore = storeFilter.value;
                const contactName = document.getElementById('contactName').value;
                const contactPhone = document.getElementById('contactPhone').value;
                const contactEmail = document.getElementById('contactEmail').value;
                const storePersonName = document.getElementById('storePersonName').value;
                const storePersonPhone = document.getElementById('storePersonPhone').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                
                // Filter data for PDF
                const filteredData = poData.filter(item => {
                    const vendorMatch = selectedVendor === 'all' || item.vendorName === selectedVendor;
                    const storeMatch = selectedStore === 'all' || item.storeName === selectedStore;
                    return vendorMatch && storeMatch;
                });
                
                // Calculate total value
                let totalValue = 0;
                filteredData.forEach(item => {
                    totalValue += item.poValue;
                });
                
                // Create a new PDF document
                const doc = new jspdf.jsPDF();
                
                // Set default font
                doc.setFont('helvetica');
                
                // Add logo if available
                let yPosition = 15;
                if (logoDataUrl) {
                    doc.addImage(logoDataUrl, 'PNG', 14, 10, 40, 20);
                    yPosition = 35;
                }
                
                // Add title
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('PURCHASE ORDER', 105, yPosition, { align: 'center' });
                yPosition += 20;
                
                // Add details section - EXACTLY like the image
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                // Left side details - single column format like the image
                doc.text(`PO Date: ${poDate}`, 14, yPosition);
                doc.text(`Reference No: ${refNo}`, 14, yPosition + 7);
                doc.text(`Delivery Date: ${deliveryDate}`, 14, yPosition + 14);
                doc.text(`Store Person: ${storePersonName || 'Not specified'}`, 14, yPosition + 21);
                doc.text(`Store Person Phone: ${storePersonPhone || 'Not specified'}`, 14, yPosition + 28);
                doc.text(`Main Store Name: ${mainStoreName}`, 14, yPosition + 35);
                doc.text(`Vendor: ${selectedVendor === 'all' ? 'Multiple Vendors' : selectedVendor}`, 14, yPosition + 42);
                
                yPosition += 55;
                
                // Add delivery address
                doc.text(`Delivery Address:`, 14, yPosition);
                // Split the address into multiple lines if it's too long
                const addressLines = doc.splitTextToSize(deliveryAddress || 'Not specified', 180);
                doc.text(addressLines, 14, yPosition + 7);
                
                // Calculate height needed for address
                const addressHeight = addressLines.length * 5;
                yPosition += 15 + addressHeight;
                
                // Prepare table data
                const tableData = filteredData.map((item, index) => {
                    return [
                        index + 1,
                        item.code,
                        item.productName,
                        item.cpu.toFixed(2),
                        item.poQty,
                        item.poValue.toFixed(2)
                    ];
                });
                
                // Add table to PDF
                doc.autoTable({
                    startY: yPosition,
                    head: [['Sl No', 'Code', 'Products Name', 'CPU', 'PO Qty', 'PO Value']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [52, 152, 219],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 70 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 25 }
                    }
                });
                
                // Get the final Y position after the table
                const finalY = doc.lastAutoTable.finalY || yPosition + 20;
                
                // Add total value in a box on the right
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                
                // Calculate box dimensions
                const totalText = `Total PO Value: ${totalValue.toFixed(2)}`;
                const textWidth = doc.getTextWidth(totalText);
                const boxWidth = textWidth + 20;
                const boxHeight = 15;
                const boxX = 190 - boxWidth; // Right aligned
                const boxY = finalY + 10;
                
                // Draw box
                doc.setFillColor(52, 152, 219);
                doc.rect(boxX, boxY, boxWidth, boxHeight, 'F');
                
                // Add text in box
                doc.setTextColor(255, 255, 255);
                doc.text(totalText, boxX + 10, boxY + 10);
                doc.setTextColor(0, 0, 0);
                
                // Add signature on the left side if available
                let signatureY = finalY + 40;
                if (signatureDataUrl) {
                    doc.addImage(signatureDataUrl, 'PNG', 14, signatureY, 50, 20);
                    doc.text('Authorized Signature', 14, signatureY + 25);
                    signatureY += 40;
                }
                
                // Add contact details in two lines at the bottom center
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const contactLine1 = 'For questions concerning this invoice, please contact';
                const contactLine2 = `Name: ${contactName}, Phone: ${contactPhone}, Email Address: ${contactEmail}`;
                
                // Center align the text
                const line1Width = doc.getTextWidth(contactLine1);
                const line2Width = doc.getTextWidth(contactLine2);
                
                doc.text(contactLine1, (210 - line1Width) / 2, signatureY + 10);
                doc.text(contactLine2, (210 - line2Width) / 2, signatureY + 17);
                
                // Save the PDF
                doc.save('purchase_order.pdf');
            }
            
            function generatePrintablePO() {
                // Get header values
                const poDate = document.getElementById('poDate').value;
                const refNo = document.getElementById('refNo').value;
                const mainStoreName = document.getElementById('storeName').value;
                const deliveryAddress = document.getElementById('deliveryAddress').value;
                const selectedVendor = vendorFilter.value;
                const selectedStore = storeFilter.value;
                const contactName = document.getElementById('contactName').value;
                const contactPhone = document.getElementById('contactPhone').value;
                const contactEmail = document.getElementById('contactEmail').value;
                const storePersonName = document.getElementById('storePersonName').value;
                const storePersonPhone = document.getElementById('storePersonPhone').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                
                // Set print header values
                printDate.textContent = poDate;
                printRefNo.textContent = refNo;
                printStoreName.textContent = mainStoreName;
                printVendor.textContent = selectedVendor === 'all' ? 'Multiple Vendors' : selectedVendor;
                printDeliveryAddress.textContent = deliveryAddress || 'Not specified';
                printContactName.textContent = contactName;
                printContactPhone.textContent = contactPhone;
                printContactEmail.textContent = contactEmail;
                printStorePersonName.textContent = storePersonName || 'Not specified';
                printStorePersonPhone.textContent = storePersonPhone || 'Not specified';
                printDeliveryDate.textContent = deliveryDate || 'Not specified';
                
                // Set logo or company name
                if (logoDataUrl) {
                    printLogoContainer.innerHTML = `<img src="${logoDataUrl}" style="max-height: 80px; max-width: 200px;" alt="Company Logo">`;
                } else {
                    printLogoContainer.innerHTML = '<h2>ROSHOD</h2>';
                }
                
                // Set signature if available
                if (signatureDataUrl) {
                    printSignatureContainer.innerHTML = `<img src="${signatureDataUrl}" style="max-height: 50px; max-width: 150px;" alt="Signature">`;
                } else {
                    printSignatureContainer.innerHTML = '';
                }
                
                // Generate printable table
                printTableBody.innerHTML = '';
                
                const filteredData = poData.filter(item => {
                    const vendorMatch = selectedVendor === 'all' || item.vendorName === selectedVendor;
                    const storeMatch = selectedStore === 'all' || item.storeName === selectedStore;
                    return vendorMatch && storeMatch;
                });
                
                let totalValue = 0;
                
                // Auto-generate SL numbers for filtered data in PDF
                filteredData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const slNo = index + 1; // Auto-generated SL number
                    
                    row.innerHTML = `
                        <td>${slNo}</td>
                        <td>${item.code}</td>
                        <td>${item.productName}</td>
                        <td>${item.cpu.toFixed(2)}</td>
                        <td>${item.poQty}</td>
                        <td>${item.poValue.toFixed(2)}</td>
                    `;
                    
                    printTableBody.appendChild(row);
                    
                    totalValue += item.poValue;
                });
                
                printTotalValue.textContent = totalValue.toFixed(2);
            }
            
            function saveToLocalStorage() {
                const dataToSave = {
                    poData: poData,
                    vendors: vendors,
                    stores: stores,
                    logoDataUrl: logoDataUrl,
                    signatureDataUrl: signatureDataUrl,
                    poDate: document.getElementById('poDate').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    refNo: document.getElementById('refNo').value,
                    storeName: document.getElementById('storeName').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    storePersonName: document.getElementById('storePersonName').value,
                    storePersonPhone: document.getElementById('storePersonPhone').value,
                    contactName: document.getElementById('contactName').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    contactEmail: document.getElementById('contactEmail').value
                };
                
                localStorage.setItem('purchaseOrderData', JSON.stringify(dataToSave));
            }
            
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem('purchaseOrderData');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    poData = data.poData || [];
                    vendors = data.vendors || [];
                    stores = data.stores || [];
                    logoDataUrl = data.logoDataUrl || null;
                    signatureDataUrl = data.signatureDataUrl || null;
                    
                    // Set form values
                    if (data.poDate) document.getElementById('poDate').value = data.poDate;
                    if (data.deliveryDate) document.getElementById('deliveryDate').value = data.deliveryDate;
                    if (data.refNo) document.getElementById('refNo').value = data.refNo;
                    if (data.storeName) document.getElementById('storeName').value = data.storeName;
                    if (data.deliveryAddress) document.getElementById('deliveryAddress').value = data.deliveryAddress;
                    if (data.storePersonName) document.getElementById('storePersonName').value = data.storePersonName;
                    if (data.storePersonPhone) document.getElementById('storePersonPhone').value = data.storePersonPhone;
                    if (data.contactName) document.getElementById('contactName').value = data.contactName;
                    if (data.contactPhone) document.getElementById('contactPhone').value = data.contactPhone;
                    if (data.contactEmail) document.getElementById('contactEmail').value = data.contactEmail;
                    
                    // Update logo preview
                    if (logoDataUrl) {
                        logoPreview.innerHTML = `<img src="${logoDataUrl}" class="logo-preview" alt="Logo">`;
                        removeLogoBtn.style.display = 'inline-block';
                    }
                    
                    // Update signature preview
                    if (signatureDataUrl) {
                        signaturePreview.innerHTML = `<img src="${signatureDataUrl}" class="signature-preview" alt="Signature">`;
                        removeSignatureBtn.style.display = 'inline-block';
                    }
                    
                    // If we have data, show the form
                    if (poData.length > 0) {
                        // Populate vendor filter
                        vendorFilter.innerHTML = '<option value="all">All Vendors</option>';
                        vendors.forEach(vendor => {
                            const option = document.createElement('option');
                            option.value = vendor;
                            option.textContent = vendor;
                            vendorFilter.appendChild(option);
                        });
                        
                        // Populate store filter
                        storeFilter.innerHTML = '<option value="all">All Stores</option>';
                        stores.forEach(store => {
                            const option = document.createElement('option');
                            option.value = store;
                            option.textContent = store;
                            storeFilter.appendChild(option);
                        });
                        
                        // Display the data
                        renderTable();
                        poForm.style.display = 'block';
                        
                        // Calculate initial total
                        calculateTotalValue();
                    }
                }
            }
            
            function clearAllData() {
                // Clear all data
                poData = [];
                vendors = [];
                stores = [];
                logoDataUrl = null;
                signatureDataUrl = null;
                
                // Reset form fields
                document.getElementById('poDate').valueAsDate = today;
                document.getElementById('deliveryDate').valueAsDate = deliveryDate;
                document.getElementById('refNo').value = '';
                document.getElementById('storeName').value = '';
                document.getElementById('deliveryAddress').value = '';
                document.getElementById('storePersonName').value = '';
                document.getElementById('storePersonPhone').value = '';
                
                // Reset logo
                logoInput.value = '';
                logoPreview.innerHTML = 'Logo Preview';
                logoPreview.className = 'logo-placeholder';
                removeLogoBtn.style.display = 'none';
                
                // Reset signature
                signatureInput.value = '';
                signaturePreview.innerHTML = 'Signature Preview';
                signaturePreview.className = 'signature-placeholder';
                removeSignatureBtn.style.display = 'none';
                
                // Reset table
                poTableBody.innerHTML = '';
                totalValueSpan.textContent = '0.00';
                
                // Hide form
                poForm.style.display = 'none';
                
                // Clear localStorage
                localStorage.removeItem('purchaseOrderData');
                
                // Reset file input
                fileInput.value = '';
            }
        });
    </script>
</body>
</html>
